\documentclass[a4paper]{article}

% subfile handling packages
\usepackage{subfiles}
\newcommand{\onlyinsubfile}[1]{#1}
\newcommand{\notinsubfile}[1]{}

% document packages
\usepackage[top=1in, bottom=1.25in, left=1.25in, right=1.25in]{geometry}
\usepackage{amsmath}
\usepackage{multicol}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{tabulary}
\usepackage{hhline}
\RequirePackage{ltxcmds}[2010/12/07]
\graphicspath{{../../images/}}
%\graphicspath
\usepackage{float}
\usepackage{amsfonts}
\usepackage{hyperref}
\usepackage{footnote}
\makesavenoteenv{tabular}

% Document metadata
\title{BPSK system}
\author{ }
\date{ }

\begin{document}
\renewcommand{\onlyinsubfile}[1]{}
\renewcommand{\notinsubfile}[1]{#1}

\maketitle

\section{Introduction}

This document describes a model to simulate a BPSK transmission system in a back-to-back configuration.
The only considered impairments are the thermal noise at the receiver.

\section{Functional Description}

A simplified diagram of the system being simulated is presented in the Figure~\ref{fig:homodynesystem}.
A random binary string is generated and encoded in an optical signal using BPSK modulation format.
The decoding of the optical signal is accomplished by an homodyne receiver, which combines the signal with a local oscillator.
The received binary signal is compared with the transmitted binary signal in order to estimate the BER.

\begin{figure}[h]
\centering
\includegraphics[width=\linewidth]{bpskdiagram.png}
\caption{Overview of the BPSK system being simulated.}
\label{fig:homodynesystem}
\end{figure}

\begin{table}[H]
\centering
\begin{tabular}{c|c}
System Blocks    & netxpto Blocks   \\ \hline
BPSK Transmitter & MQamTransmitter  \\
BPSK Receiver    & HomodyneReceiver \\
BER Estimator    & BitErrorRate
\end{tabular}
\end{table}

\section{Required files}\label{Required files}
%
Header Files
\begin{savenotes}
\begin{table}[H]
\centering
\begin{tabulary}{1.0\textwidth}{|L|L|}
\hline
\textbf{File}          & \textbf{Description} 																 \\ \hline
netxpto.h              & Generic purpose simulator definitions.		          										 \\
\hline
\end{tabulary}
\end{table}		
\end{savenotes}	
%
Source Files
Header Files
\begin{savenotes}
\begin{table}[H]
\centering
\begin{tabulary}{1.0\textwidth}{|L|L|}
\hline
\textbf{File}          & \textbf{Description} 																 \\ \hline
netxpto.cpp            & Generic purpose simulator implementations.		          										 \\
\hline
\end{tabulary}
\end{table}		
\end{savenotes}	


\section{System Input Parameters}

This system takes into account the following input parameters:

\begin{savenotes}
\begin{table}[H]
\centering
\begin{tabulary}{1.0\textwidth}{|C|C|}
\hline
\textbf{System Parameters}      & \textbf{Description} 																 \\ \hline
NumberOfBits           & Gives the number of bits to be simulated		          										 \\ \hline
BitPeriod              & Sets the time between adjacent bits                                                           \\ \hline
SamplesPerSymbol       & Establishes the number of samples each bit in the string is given \footnotemark[1]	         \\ \hline
pLength                & PRBS pattern length					                      									 \\ \hline
iqAmplitudesValues     & Sets the state constellation																	 \\ \hline
outOpticalPower\_dBm   & Sets the optical power, in units of dBm, at the transmitter output							 \\ \hline
LOoutOpticalPower\_dBm & Sets the optical power, in units of dBm, of the local oscillator used in the homodyne detector \\ \hline
LocalOscillatorPhase   & Sets the initial phase of the local oscillator used in the homodyne detector					 \\ \hline
TransferMatrix         & Sets the transfer matrix of the beam splitter used in the homodyne detector					 \\ \hline
Responsivity           & Sets the responsivity of the photodiodes used in the homodyne detector						 \\ \hline
Amplification          & Sets the amplification of the trans-impedance amplifier used in the homodyne detector			 \\ \hline
NoiseAmplitude         & Sets the amplitude of the gaussian thermal noise added in the homodyne detector				 \\ \hline
Delay                  & Sets the delay factor of the homodyne detector												 \\ \hline
PosReferenceValue      & \multirow{2}{*}{Set the positive and negative reference values for the bit decision block}     \\ \cline{1-1}
NegReferenceValue      &                                                                                                \\ \hline
Confidence             & Sets the confidence interval for the calculated QBER                                           \\ \hline
MidReportSize          & Sets the number of bits between generated QBER mid-reports                                     \\
\hline
\end{tabulary}
\end{table}		
\end{savenotes}	

\footnotetext[1]{Simulation time resolution = $\frac{\text{BitPeriod}}{\text{\text{SamplesPerSymbol}}}$}

\section{Inputs}

This system takes no inputs.

\section{Outputs}

This system outputs the following objects:
\begin{itemize}
\item Signals:
\begin{itemize}
\item Initial Binary String; (MQAM$_0$)
\item Optical Signal with coded Binary String; (S$_{00}$)
\item Decoded Binary String; (S$_{01}$)
\end{itemize}
\item Other:
\begin{itemize}
\item Bit Error Rate report in the form of a .txt file. (BER.txt)
\end{itemize}
\end{itemize}

\subsection{BER evolution}

The following results show the dependence of the error rate with the signal power assuming a constant Local Oscillator power of $-20~dBm$. For reference, the eye diagram at 3 different power levels are also presented

\begin{figure}[H]
\centering
\includegraphics[width=\linewidth, trim= 0mm 85mm 0mm 85mm, clip]{berevolution.pdf}
\caption{Bit Error Rate in function of the signal power in dBm.}
\label{fig:berevolution}
\end{figure}

\begin{figure}[H]
\centering
\begin{subfigure}{.3\linewidth}
\includegraphics[width=\linewidth]{eyeclosed.png}
\caption{Power=-180dBm}
\end{subfigure}
\begin{subfigure}{.3\linewidth}
\includegraphics[width=\linewidth]{eyepartial.png}
\caption{Power=-130dBm}
\end{subfigure}
\begin{subfigure}{.3\linewidth}
\includegraphics[width=\linewidth]{eyeopen.png}
\caption{Power=-100dBm}
\end{subfigure}
\caption{Eye diagrams at different signal powers.}
\end{figure}


\section{Simulation Results}

We consider the following scenarios:
\begin{itemize}
\item \ref{subsec:scenario1} Basic BPSK back to back with  thermal noise.
\end{itemize}

\subsection{BPSK with thermal noise}\label{subsec:scenario1}

The following results were obtained from the simulation using the following input parameters:
\begin{table}[H]
\centering
\begin{tabular}{rl}
NumberOfBits=           & 1000                                                     \\
SamplesPerSymbol=       & 16                                                       \\
pLength=                & 5                                                        \\
iqAmplitudesValues=     & \{ \{ 1, 0 \}, \{ -1, 0 \} \}                            \\
outOpticalPower\_dBm=   & -20                                                      \\
LOoutOpticalPower\_dBm= & -10                                                      \\
LocalOscillatorPhase=   & 0                                                        \\
TransferMatrix=         & \{ \{ 1/sqrt(2), 1/sqrt(2), 1/sqrt(2), -1/sqrt(2) \} \}  \\
Responsivity=           & 1                                                        \\
Amplification=          & 1e6                                                      \\
NoiseAmplitude=         & 15.397586549153788                                       \\
Delay=                  & 9                                                        \\
\end{tabular}
\end{table}

The system took the binary string presented in Figure~\ref{fig:sentkey} and encoded it into the optical signal in Figure~\ref{fig:sentsig}. Notice the BPSK constelation of the signal, presented in Figure~\ref{fig:constellation}.
\begin{figure}[H]
\centering
\includegraphics[width=\linewidth, trim= 0mm 95mm 0mm 95mm, clip]{binarystring.pdf}
\caption{Sent binary key.}
\label{fig:sentkey}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=\linewidth, trim= 0mm 95mm 0mm 95mm, clip]{sentsignal.pdf}
\caption{Sent signal.}
\label{fig:sentsig}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=\linewidth, trim= 0mm 95mm 0mm 95mm, clip]{constellation.pdf}
\caption{Constellation of the sent signal.}
\label{fig:constellation}
\end{figure}

Homodyne detection is then performed, using to that effect the local oscillator signal presented in Figure~\ref{fig:local}. Figures~\ref{fig:subtract}~and~\ref{fig:noisy} show the addition of noise to the signal.

\begin{figure}[H]
\centering
\includegraphics[width=\linewidth, trim= 0mm 95mm 0mm 95mm, clip]{localosc.pdf}
\caption{Homodyne receiver internal signal: local oscillator used for Homodyne detection.}
\label{fig:local}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=\linewidth, trim= 0mm 95mm 0mm 95mm, clip]{subtract.pdf}
\caption{Homodyne receiver internal signal: subtraction of the signals outputted by the photodiodes.}
\label{fig:subtract}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=\linewidth, trim= 0mm 95mm 0mm 95mm, clip]{noisy.pdf}
\caption{Homodyne receiver internal signal: amplification of the signal in Figure~\ref{fig:subtract} with added noise.}
\label{fig:noisy}
\end{figure}

The result of the homodyne detection is the binary string presented in~\ref{fig:decoded}, which is then compared to the original binary string by the BER block, which outputs the report presented in Figure~\ref{fig:ber}.

\begin{figure}[H]
\centering
\includegraphics[width=\linewidth, trim= 0mm 95mm 0mm 95mm, clip]{decodedbinarystring.pdf}
\caption{Decoded binary string, output of the Homodyne receiver block.}
\label{fig:decoded}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=\linewidth]{berreport.png}
\caption{Bit-Error-Rate report.}
\label{fig:ber}
\end{figure}



\section{Block Description}

\subsection{MQAM Transmitter}
% subfile goes here

\subsection{Homodyne Receiver}
\subfile{../../lib/tex/homodyne_reciever}


\subsection{Bit Error Rate}
\subfile{../../lib/tex/ber}

\subsection{Local Oscillator}
\subfile{../../lib/tex/localoscillator}

\subsection{Beam Splitter}
\subfile{../../lib/tex/beamsplitter}

\subsection{Photodiode}
\subfile{../../lib/tex/photodiode}

\subsection{Amplifier}
\subfile{../../lib/tex/amplifier}

\subsection{Electrical Filter}
\subfile{../../lib/tex/electrical_filter}

\subsection{Sampler}
\subfile{../../lib/tex/sampler}

\subsection{Bit Decider}
\subfile{../../lib/tex/decider}

\subsection{Bit Error Rate}
\subfile{../../lib/tex/ber}

\section{Known Problems}
\begin{enumerate}
    \item{Finish section~\ref{Required files} of this document.}
    \item{Change figure 1 to increase the lines width and to include the block Sink, and to include the signals names S0, S1, S2, S3.}
    \item Homodyne Super-Block not functioning
    \item MQAM Transmitter PDF needs to be written
    \item 8 bits being lost of every signal
    \item If the bit string length is larger than 512, this first 512 bits are lost
\end{enumerate}

\end{document} 